<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Events - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheet/style.css" />
</head>
<body>
    <%- include('../partials/navbar') %>
    
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-calendar-alt me-2"></i>Manage Events
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">
                <i class="fas fa-plus me-2"></i>Create Event
            </button>
        </div>
        
        <!-- Alert container for dynamic messages -->
        <div id="alertContainer"></div>
        
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <%= success %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>
        
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>
        
        <div class="card">
            <div class="card-body">
                <% if (events && events.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Event Name</th>
                                    <th>Date & Time</th>
                                    <th>Location</th>
                                    <th>Capacity</th>
                                    <th>Available</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% events.forEach(function(event) { %>
                                    <tr>
                                        <td>
                                            <strong><%= event.event_name %></strong>
                                            <% if (event.event_type) { %>
                                                <br><small class="text-muted"><%= event.event_type %></small>
                                            <% } %>
                                        </td>
                                        <td>
                                            <%= new Date(event.event_date).toLocaleDateString() %>
                                            <% if (event.event_time) { %>
                                                <br><small><%= event.event_time %></small>
                                            <% } %>
                                        </td>
                                        <td><%= event.location || 'TBD' %></td>
                                        <td><%= event.capacity %></td>
                                        <td>
                                            <span class="badge bg-<%= event.available_tickets > 0 ? 'success' : 'danger' %>">
                                                <%= event.available_tickets %>
                                            </span>
                                        </td>
                                        <td>$<%= parseFloat(event.ticket_price).toFixed(2) %></td>
                                        <td>
                                            <span class="badge bg-<%= event.status === 'upcoming' ? 'primary' : event.status === 'ongoing' ? 'warning' : event.status === 'completed' ? 'success' : 'secondary' %>">
                                                <%= event.status %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="editEvent(<%= event.event_id %>)" title="Edit Event">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <a href="/admin/events/<%= event.event_id %>/tickets" class="btn btn-outline-info" title="Manage Tickets">
                                                    <i class="fas fa-ticket-alt"></i>
                                                </a>
                                                <button class="btn btn-outline-danger" onclick="deleteEvent(<%= event.event_id %>)" title="Delete Event">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No events found</h4>
                        <p class="text-muted">Create your first event to get started!</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <!-- Create Event Modal -->
    <div class="modal fade" id="createEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/admin/events/create" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="event_name" class="form-label">Event Name *</label>
                                    <input type="text" class="form-control" id="event_name" name="event_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="event_type" class="form-label">Event Type</label>
                                    <select class="form-select" id="event_type" name="event_type">
                                        <option value="">Select type</option>
                                        <option value="match">Match</option>
                                        <option value="training">Training</option>
                                        <option value="meetup">Fan Meetup</option>
                                        <option value="charity">Charity Event</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="event_date" class="form-label">Event Date *</label>
                                    <input type="date" class="form-control" id="event_date" name="event_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="event_time" class="form-label">Event Time</label>
                                    <input type="time" class="form-control" id="event_time" name="event_time">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location">
                        </div>
                        
                        <div class="mb-3">
                            <label for="event_desc" class="form-label">Description</label>
                            <textarea class="form-control" id="event_desc" name="event_desc" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="capacity" class="form-label">Capacity *</label>
                                    <input type="number" class="form-control" id="capacity" name="capacity" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="ticket_price" class="form-label">Ticket Price *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="ticket_price" name="ticket_price" 
                                               min="0" step="0.01" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="upcoming">Upcoming</option>
                                        <option value="ongoing">Ongoing</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Event Modal -->
    <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="editEventForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="editEventLoading" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading event details...</p>
                        </div>
                        
                        <div id="editEventContent">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_event_name" class="form-label">Event Name *</label>
                                        <input type="text" class="form-control" id="edit_event_name" name="event_name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_event_type" class="form-label">Event Type</label>
                                        <select class="form-select" id="edit_event_type" name="event_type">
                                            <option value="">Select type</option>
                                            <option value="match">Match</option>
                                            <option value="training">Training</option>
                                            <option value="meetup">Fan Meetup</option>
                                            <option value="charity">Charity Event</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_event_date" class="form-label">Event Date *</label>
                                        <input type="date" class="form-control" id="edit_event_date" name="event_date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_event_time" class="form-label">Event Time</label>
                                        <input type="time" class="form-control" id="edit_event_time" name="event_time">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="edit_location" name="location">
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_event_desc" class="form-label">Description</label>
                                <textarea class="form-control" id="edit_event_desc" name="event_desc" rows="3"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="edit_capacity" class="form-label">Capacity *</label>
                                        <input type="number" class="form-control" id="edit_capacity" name="capacity" min="1" required>
                                        <div class="form-text">
                                            <small class="text-muted">Current available tickets will be adjusted automatically</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="edit_ticket_price" class="form-label">Ticket Price *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="edit_ticket_price" name="ticket_price" 
                                                   min="0" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="edit_status" class="form-label">Status</label>
                                        <select class="form-select" id="edit_status" name="status">
                                            <option value="upcoming">Upcoming</option>
                                            <option value="ongoing">Ongoing</option>
                                            <option value="completed">Completed</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveEventBtn">
                            <span class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <%- include('../partials/footer') %>
    
    
    <script>
        let currentEditEventId = null;
        
        // Helper function to show dynamic alerts
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Clear any existing alerts
            alertContainer.innerHTML = '';
            
            // Add the new alert
            alertContainer.appendChild(alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        async function editEvent(eventId) {
            currentEditEventId = eventId;
            
            // Show modal and loading state
            const modal = new bootstrap.Modal(document.getElementById('editEventModal'));
            document.getElementById('editEventLoading').style.display = 'block';
            document.getElementById('editEventContent').style.display = 'none';
            modal.show();
            
            try {
                // Fetch event details
                const response = await fetch(`/admin/events/${eventId}/edit`);
                const data = await response.json();
                
                if (data.success) {
                    const event = data.event;
                    
                    // Populate form fields
                    document.getElementById('edit_event_name').value = event.event_name || '';
                    document.getElementById('edit_event_type').value = event.event_type || '';
                    
                    // Format date for input field (YYYY-MM-DD)
                    if (event.event_date) {
                        const date = new Date(event.event_date);
                        document.getElementById('edit_event_date').value = date.toISOString().split('T')[0];
                    }
                    
                    // Format time for input field (HH:MM)
                    if (event.event_time) {
                        document.getElementById('edit_event_time').value = event.event_time;
                    }
                    
                    document.getElementById('edit_location').value = event.location || '';
                    document.getElementById('edit_event_desc').value = event.event_desc || '';
                    document.getElementById('edit_capacity').value = event.capacity || '';
                    document.getElementById('edit_ticket_price').value = event.ticket_price || '';
                    document.getElementById('edit_status').value = event.status || 'upcoming';
                    
                    // Hide loading, show content
                    document.getElementById('editEventLoading').style.display = 'none';
                    document.getElementById('editEventContent').style.display = 'block';
                } else {
                    throw new Error(data.message || 'Failed to load event details');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showAlert('Error loading event details: ' + error.message, 'danger');
                modal.hide();
            }
        }
        
        // Handle edit form submission
        document.getElementById('editEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditEventId) {
                showAlert('No event selected for editing', 'danger');
                return;
            }
            
            const saveBtn = document.getElementById('saveEventBtn');
            const spinner = saveBtn.querySelector('.spinner-border');
            
            // Show loading state
            saveBtn.disabled = true;
            spinner.style.display = 'inline-block';
            
            try {
                // Collect form data
                const formData = new FormData(this);
                const eventData = Object.fromEntries(formData.entries());
                
                // Send update request
                const response = await fetch(`/admin/events/${currentEditEventId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Success - close modal and show success message
                    bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
                    
                    // Show success message
                    showAlert(result.message, 'success');
                    
                    // Reload page after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to update event');
                }
            } catch (error) {
                console.error('Error updating event:', error);
                showAlert('Error updating event: ' + error.message, 'danger');
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                spinner.style.display = 'none';
            }
        });
        
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                fetch(`/admin/events/${eventId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Event deleted successfully', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert('Error deleting event: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error deleting event:', error);
                    showAlert('Error deleting event', 'danger');
                });
            }
        }
        
        // Set minimum date to today for both create and edit forms
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('event_date').min = today;
        document.getElementById('edit_event_date').min = today;
        
        // Reset edit modal when closed
        document.getElementById('editEventModal').addEventListener('hidden.bs.modal', function () {
            currentEditEventId = null;
            document.getElementById('editEventLoading').style.display = 'none';
            document.getElementById('editEventContent').style.display = 'block';
            document.getElementById('editEventForm').reset();
        });
    </script>
    
</body>
</html>