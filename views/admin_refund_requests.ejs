<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Refund Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/stylesheet/style.css" />
    <link rel="stylesheet" href="/stylesheet/admin_refund.css" />
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <div class="list-group">
                    <a href="/admin/dashboard" class="list-group-item list-group-item-action">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a href="/admin/users" class="list-group-item list-group-item-action">
                        <i class="fas fa-users me-2"></i>Users
                    </a>
                    <a href="/admin/orders" class="list-group-item list-group-item-action">
                        <i class="fas fa-shopping-cart me-2"></i>Orders
                    </a>
                    <a href="/admin/refund-requests" class="list-group-item list-group-item-action active">
                        <i class="fas fa-undo me-2"></i>Refund Requests
                    </a>
                    <a href="/admin/gear" class="list-group-item list-group-item-action">
                        <i class="fas fa-box me-2"></i>Gear Management
                    </a>
                </div>
            </div>
            
            <div class="col-md-10">
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Setup Required:</strong> <%= error %>
                    </div>
                <% } %>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-undo me-2"></i>Refund Requests Management</h2>
                    <div class="btn-group">
                        <span class="badge bg-warning fs-6 me-2">
                            <i class="fas fa-clock me-1"></i>Pending: <%= refundRequests.pending.length %>
                        </span>
                        <span class="badge bg-success fs-6 me-2">
                            <i class="fas fa-check me-1"></i>Approved: <%= refundRequests.approved.length %>
                        </span>
                        <span class="badge bg-danger fs-6 me-2">
                            <i class="fas fa-times me-1"></i>Rejected: <%= refundRequests.rejected.length %>
                        </span>
                        <span class="badge bg-primary fs-6">
                            <i class="fas fa-money-bill me-1"></i>Processed: <%= refundRequests.processed.length %>
                        </span>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="refundTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                            <i class="fas fa-clock me-1"></i>Pending (<%= refundRequests.pending.length %>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                            <i class="fas fa-check me-1"></i>Approved (<%= refundRequests.approved.length %>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                            <i class="fas fa-times me-1"></i>Rejected (<%= refundRequests.rejected.length %>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="processed-tab" data-bs-toggle="tab" data-bs-target="#processed" type="button" role="tab">
                            <i class="fas fa-money-bill me-1"></i>Processed (<%= refundRequests.processed.length %>)
                        </button>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content mt-4" id="refundTabsContent">
                    <!-- Pending Requests -->
                    <div class="tab-pane fade show active" id="pending" role="tabpanel">
                        <% if (refundRequests.pending.length > 0) { %>
                            <div class="row">
                                <% refundRequests.pending.forEach(request => { %>
                                    <div class="col-md-6 mb-4">
                                        <div class="card refund-card status-pending">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Order #<%= request.order_id %></h6>
                                                    <span class="badge bg-warning">Pending</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Customer:</strong> <%= request.first_name %> <%= request.surname %></p>
                                                <p><strong>Email:</strong> <%= request.email %></p>
                                                <% if (request.phone) { %>
                                                    <p><strong>Phone:</strong> <%= request.phone %></p>
                                                <% } %>
                                                <p><strong>Order Total:</strong> $<%= parseFloat(request.order_total || request.final_amount || 0).toFixed(2) %></p>
                                                <p><strong>Refund Amount:</strong> $<%= parseFloat(request.refund_amount || request.order_total || request.final_amount || 0).toFixed(2) %></p>
                                                <p><strong>Payment Method:</strong> <%= request.payment_method || 'N/A' %></p>
                                                <% if (request.order_items) { %>
                                                    <p><strong>Items Ordered:</strong></p>
                                                    <div class="order-items mb-2">
                                                        <small class="text-muted"><%= request.order_items %></small>
                                                    </div>
                                                <% } %>
                                                <p><strong>Reason:</strong> <%= request.reason %></p>
                                                <% if (request.detailed_reason && request.detailed_reason.trim()) { %>
                                                    <p><strong>Details:</strong> <%= request.detailed_reason %></p>
                                                <% } %>
                                                <p><strong>Requested:</strong> <%= new Date(request.requested_at).toLocaleDateString() %></p>
                                                
                                                <div class="mt-3">
                                                    <button class="btn btn-success btn-sm me-2" onclick="processRefund(<%= request.refund_id %>, 'approve')">
                                                        <i class="fas fa-check me-1"></i>Approve
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="processRefund(<%= request.refund_id %>, 'reject')">
                                                        <i class="fas fa-times me-1"></i>Reject
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                                <h4 class="text-muted">No pending refund requests</h4>
                            </div>
                        <% } %>
                    </div>

                    <!-- Approved Requests -->
                    <div class="tab-pane fade" id="approved" role="tabpanel">
                        <% if (refundRequests.approved.length > 0) { %>
                            <div class="row">
                                <% refundRequests.approved.forEach(request => { %>
                                    <div class="col-md-6 mb-4">
                                        <div class="card refund-card status-approved">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Order #<%= request.order_id %></h6>
                                                    <span class="badge bg-success">Approved</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Customer:</strong> <%= request.first_name %> <%= request.surname %></p>
                                                <p><strong>Email:</strong> <%= request.email %></p>
                                                <% if (request.phone) { %>
                                                    <p><strong>Phone:</strong> <%= request.phone %></p>
                                                <% } %>
                                                <p><strong>Order Total:</strong> $<%= parseFloat(request.order_total || request.final_amount || 0).toFixed(2) %></p>
                                                <p><strong>Refund Amount:</strong> $<%= parseFloat(request.refund_amount || request.order_total || request.final_amount || 0).toFixed(2) %></p>
                                                <p><strong>Payment Method:</strong> <%= request.payment_method || 'N/A' %></p>
                                                <% if (request.order_items) { %>
                                                    <p><strong>Items Ordered:</strong></p>
                                                    <div class="order-items mb-2">
                                                        <small class="text-muted"><%= request.order_items %></small>
                                                    </div>
                                                <% } %>
                                                <p><strong>Reason:</strong> <%= request.reason %></p>
                                                <% if (request.detailed_reason && request.detailed_reason.trim()) { %>
                                                    <p><strong>Details:</strong> <%= request.detailed_reason %></p>
                                                <% } %>
                                                <p><strong>Approved:</strong> 
                                                    <%= request.processed_at ? new Date(request.processed_at).toLocaleDateString() : 'N/A' %>
                                                </p>
                                                <% if (request.admin_notes) { %>
                                                    <p><strong>Admin Notes:</strong> <%= request.admin_notes %></p>
                                                <% } %>
                                                
                                                <div class="mt-3">
                                                    <button class="btn btn-primary btn-sm" onclick="processRefund(<%= request.refund_id %>, 'process')">
                                                        <i class="fas fa-money-bill me-1"></i>Mark as Processed
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle text-muted mb-3" style="font-size: 3rem;"></i>
                                <h4 class="text-muted">No approved refund requests</h4>
                            </div>
                        <% } %>
                    </div>

                    <!-- Rejected Requests -->
                    <div class="tab-pane fade" id="rejected" role="tabpanel">
                        <% if (refundRequests.rejected.length > 0) { %>
                            <div class="row">
                                <% refundRequests.rejected.forEach(request => { %>
                                    <div class="col-md-6 mb-4">
                                        <div class="card refund-card status-rejected">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Order #<%= request.order_id %></h6>
                                                    <span class="badge bg-danger">Rejected</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Customer:</strong> <%= request.first_name %> <%= request.surname %></p>
                                                <p><strong>Email:</strong> <%= request.email %></p>
                                                <p><strong>Amount:</strong> $<%= parseFloat(request.refund_amount).toFixed(2) %></p>
                                                <p><strong>Reason:</strong> <%= request.reason %></p>
                                                <% if (request.detailed_reason && request.detailed_reason.trim()) { %>
                                                    <p><strong>Details:</strong> <%= request.detailed_reason %></p>
                                                <% } %>
                                                <p><strong>Rejected:</strong> 
                                                    <%= request.processed_at ? new Date(request.processed_at).toLocaleDateString() : 'N/A' %>
                                                </p>
                                                <% if (request.admin_notes) { %>
                                                    <p><strong>Admin Notes:</strong> <%= request.admin_notes %></p>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-times-circle text-muted mb-3" style="font-size: 3rem;"></i>
                                <h4 class="text-muted">No rejected refund requests</h4>
                            </div>
                        <% } %>
                    </div>

                    <!-- Processed Requests -->
                    <div class="tab-pane fade" id="processed" role="tabpanel">
                        <% if (refundRequests.processed.length > 0) { %>
                            <div class="row">
                                <% refundRequests.processed.forEach(request => { %>
                                    <div class="col-md-6 mb-4">
                                        <div class="card refund-card status-processed">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Order #<%= request.order_id %></h6>
                                                    <span class="badge bg-primary">Processed</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Customer:</strong> <%= request.first_name %> <%= request.surname %></p>
                                                <p><strong>Email:</strong> <%= request.email %></p>
                                                <p><strong>Amount:</strong> $<%= parseFloat(request.refund_amount).toFixed(2) %></p>
                                                <p><strong>Payment Method:</strong> <%= request.payment_method || 'N/A' %></p>
                                                <p><strong>Reason:</strong> <%= request.reason %></p>
                                                <% if (request.detailed_reason && request.detailed_reason.trim()) { %>
                                                    <p><strong>Details:</strong> <%= request.detailed_reason %></p>
                                                <% } %>
                                                <p><strong>Processed:</strong> 
                                                    <%= request.processed_at ? new Date(request.processed_at).toLocaleDateString() : 'N/A' %>
                                                </p>
                                                <% if (request.admin_notes) { %>
                                                    <p><strong>Admin Notes:</strong> <%= request.admin_notes %></p>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-money-bill text-muted mb-3" style="font-size: 3rem;"></i>
                                <h4 class="text-muted">No processed refund requests</h4>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <!-- Process Refund Modal -->
    <div class="modal fade" id="processRefundModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Process Refund Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="processRefundForm">
                        <input type="hidden" id="refundId" name="refundId">
                        <input type="hidden" id="refundAction" name="action">
                        
                        <div class="mb-3">
                            <label for="adminNotes" class="form-label">Admin Notes</label>
                            <textarea class="form-control" id="adminNotes" name="admin_notes" rows="3" placeholder="Add any notes about this decision..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="actionMessage"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn" id="confirmAction">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function processRefund(refundId, action) {
            if (!refundId || !action) {
                alert('Invalid refund request data');
                return;
            }
            
            document.getElementById('refundId').value = refundId;
            document.getElementById('refundAction').value = action;
            
            const actionMessage = document.getElementById('actionMessage');
            const confirmButton = document.getElementById('confirmAction');
            
            switch(action) {
                case 'approve':
                    actionMessage.textContent = 'This will approve the refund request. The customer will be notified.';
                    confirmButton.className = 'btn btn-success';
                    confirmButton.textContent = 'Approve';
                    break;
                case 'reject':
                    actionMessage.textContent = 'This will reject the refund request. The customer will be notified.';
                    confirmButton.className = 'btn btn-danger';
                    confirmButton.textContent = 'Reject';
                    break;
                case 'process':
                    actionMessage.textContent = 'This will mark the refund as processed. Make sure payment has been refunded.';
                    confirmButton.className = 'btn btn-primary';
                    confirmButton.textContent = 'Mark as Processed';
                    break;
                default:
                    alert('Invalid action');
                    return;
            }
            
            new bootstrap.Modal(document.getElementById('processRefundModal')).show();
        }
        
        document.getElementById('confirmAction').addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('processRefundForm'));
            const refundId = formData.get('refundId');
            const action = formData.get('action');
            const adminNotes = formData.get('admin_notes');
            
            // Validate inputs
            if (!refundId || !action) {
                alert('Missing required information');
                return;
            }
            
            // Disable button to prevent double submission
            const confirmButton = document.getElementById('confirmAction');
            confirmButton.disabled = true;
            confirmButton.textContent = 'Processing...';
            
            try {
                const response = await fetch(`/admin/refund-requests/${refundId}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action, admin_notes: adminNotes })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + (result.message || 'Unknown error occurred'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing the request: ' + error.message);
            } finally {
                // Re-enable button
                confirmButton.disabled = false;
                confirmButton.textContent = 'Confirm';
            }
        });
    </script>
</body>
</html>
