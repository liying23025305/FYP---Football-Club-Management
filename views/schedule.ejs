<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Schedule</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/stylesheet/style.css" />
  <link rel="stylesheet" href="/stylesheet/schedule.css" />
  <style>
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar .day {
      padding: 10px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      text-align: center;
      border-radius: 5px;
    }
    .calendar .header {
      font-weight: bold;
      background-color: #007bff;
      color: white;
    }
    .calendar .today {
      background-color: #ffc107;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <%- include('partials/navbar') %>

  <main class="container mt-5">
    <div class="row">
      <!-- Left Column (Calendar + Schedule) -->
      <div class="col-lg-9">
        <!-- Calendar -->
        <div class="p-4 mb-4 bg-light border rounded shadow-sm">
          <h2 class="mb-3">ðŸ—“ Schedule Calendar</h2>
          <% 
            // Group schedules by date for quick lookup
            const scheduleMap = {};
            schedules.forEach(s => {
              let dateStr = '';
              if (s.start_time instanceof Date) {
                dateStr = s.start_time.toISOString().slice(0,10);
              } else if (typeof s.start_time === 'string' && s.start_time.length >= 10) {
                dateStr = s.start_time.slice(0,10);
              }
              if (dateStr) {
                if (!scheduleMap[dateStr]) scheduleMap[dateStr] = [];
                scheduleMap[dateStr].push(s);
              }
            });
            // Use year/month from backend
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month+1, 0).getDate();
            const today = new Date();
          %>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <form method="get" action="/schedule" class="d-inline">
              <input type="hidden" name="month" value="<%= month === 0 ? 11 : month - 1 %>">
              <input type="hidden" name="year" value="<%= month === 0 ? year - 1 : year %>">
              <button type="submit" class="btn btn-outline-primary btn-sm">&lt; Prev</button>
            </form>
            <h5 class="mb-0">
              <%= new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' }) %>
            </h5>
            <form method="get" action="/schedule" class="d-inline">
              <input type="hidden" name="month" value="<%= month === 11 ? 0 : month + 1 %>">
              <input type="hidden" name="year" value="<%= month === 11 ? year + 1 : year %>">
              <button type="submit" class="btn btn-outline-primary btn-sm">Next &gt;</button>
            </form>
          </div>
          <div class="calendar mb-3">
            <% for(let i=0; i<firstDay; i++) { %>
              <div class="day" style="width:40px; height:40px;"></div>
            <% } %>
            <% for(let d=1; d<=daysInMonth; d++) { 
                const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const hasSchedule = scheduleMap[dateStr];
                const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            %>
              <form method="get" action="/schedule" style="display:inline;">
                <input type="hidden" name="year" value="<%= year %>">
                <input type="hidden" name="month" value="<%= month %>">
                <input type="hidden" name="date" value="<%= dateStr %>">
                <button type="submit" class="day <%= hasSchedule ? 'bg-warning' : '' %> <%= isToday ? 'today' : '' %>" style="width:40px; height:40px; border:none; padding:0; margin:0;">
                  <%= d %>
                  <% if (hasSchedule) { %>
                    <span style="display:block; font-size:10px; color:#007bff;">â€¢</span>
                  <% } %>
                </button>
              </form>
            <% } %>
          </div>
        </div>

        <!-- Schedule Table -->
        <div class="p-4 bg-white border rounded shadow-sm mb-4">
          <h3 class="mb-3">
            <% if (selectedDate) { %>
              Schedules for <%= selectedDate %>
              <a href="/schedule?month=<%= month %>&year=<%= year %>" class="btn btn-link btn-sm">(Show All)</a>
            <% } else { %>
              Upcoming Matches & Training Sessions
            <% } %>
          </h3>
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-primary">
                <tr>
                  <th>Date</th>
                  <th>Title</th>
                  <th>Venue</th>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Team</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% 
                  function formatDate(dt) {
                    if (!dt) return '';
                    if (dt instanceof Date) return dt.toISOString().slice(0,10);
                    if (typeof dt === 'string' && dt.length >= 10) return dt.slice(0,10);
                    return dt;
                  }
                  function formatTime(dt) {
                    if (!dt) return '';
                    if (dt instanceof Date) return dt.toTimeString().slice(0,5);
                    if (typeof dt === 'string' && dt.length >= 16) return dt.slice(11,16);
                    return dt;
                  }
                  let filteredSchedules = schedules;
                  if (selectedDate) {
                    filteredSchedules = schedules.filter(s => formatDate(s.start_time) === selectedDate);
                  }
                %>
                <% filteredSchedules.forEach(function(s) { %>
                  <tr>
                    <td><%= formatDate(s.start_time) %></td>
                    <td><%= s.title %></td>
                    <td><%= s.location %></td>
                    <td><%= formatTime(s.start_time) %> - <%= formatTime(s.end_time) %></td>
                    <td><%= s.schedule_type %></td>
                    <td><%= s.team %></td>
                    <td>
                      <a href="/schedule?edit=<%= s.schedule_id %>&month=<%= month %>&year=<%= year %><%= selectedDate ? '&date=' + selectedDate : '' %>" class="btn btn-warning btn-sm">Edit</a>
                      <form action="/schedule/delete/<%= s.schedule_id %>" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this schedule?');">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Add/Edit Schedule Form -->
        <div class="card mb-4">
          <div class="card-body">
            <h3><%= editSchedule ? "Edit" : "Add New" %> Schedule</h3>
            <form action="<%= editSchedule ? '/schedule/edit/' + editSchedule.schedule_id : '/schedule/add' %>" method="POST">
              <div class="mb-3">
                <label>Date</label>
                <input type="date" name="date" class="form-control" value="<%= editSchedule ? formatDate(editSchedule.start_time) : '' %>" required>
              </div>
              <div class="mb-3">
                <label>Title</label>
                <input type="text" name="title" class="form-control" value="<%= editSchedule ? editSchedule.title : '' %>" required>
              </div>
              <div class="mb-3">
                <label>Description</label>
                <input type="text" name="description" class="form-control" value="<%= editSchedule ? editSchedule.description : '' %>">
              </div>
              <div class="mb-3">
                <label>Venue</label>
                <input type="text" name="location" class="form-control" value="<%= editSchedule ? editSchedule.location : '' %>" required>
              </div>
              <div class="mb-3">
                <label>Schedule Type</label>
                <select name="schedule_type" class="form-control" required>
                  <% const types = ['training', 'match', 'meeting', 'event']; %>
                  <% types.forEach(function(type) { %>
                    <option value="<%= type %>" <%= editSchedule && editSchedule.schedule_type === type ? 'selected' : '' %>><%= type.charAt(0).toUpperCase() + type.slice(1) %></option>
                  <% }); %>
                </select>
              </div>
              <div class="mb-3">
                <label>Team</label>
                <input type="text" name="team" class="form-control" value="<%= editSchedule ? editSchedule.team : '' %>">
              </div>
              <div class="mb-3">
                <label>Start Time</label>
                <input type="time" name="start_time" class="form-control" value="<%= editSchedule ? formatTime(editSchedule.start_time) : '' %>" required>
              </div>
              <div class="mb-3">
                <label>End Time</label>
                <input type="time" name="end_time" class="form-control" value="<%= editSchedule ? formatTime(editSchedule.end_time) : '' %>" required>
              </div>
              <button type="submit" class="btn btn-success"><%= editSchedule ? "Update" : "Add" %> Schedule</button>
              <% if (editSchedule) { %>
                <a href="/schedule" class="btn btn-secondary">Cancel</a>
              <% } %>
            </form>
          </div>
        </div>
      </div>

      <!-- Right Column (Announcements) -->
      <div class="col-lg-3 mt-4 mt-lg-0">
        <div class="p-3 bg-info text-white rounded shadow-sm">
          <h4 class="mb-3">ðŸ“¢ Announcements</h4>
          <ul class="list-unstyled">
            <li>âš¡ New Ego Rankings to be revealed this Friday</li>
            <li>ðŸ”¥ Nagiâ€™s ego test results published</li>
            <li>ðŸ“¸ Team Z Reunion training scheduled next week</li>
            <li>ðŸ“… Special Barou training drill: June 1, 9AM</li>
            <li>ðŸŽ¥ Rin vs Isagi replay coming to BlueTube</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <%- include('partials/footer') %>
</body>
</html>
