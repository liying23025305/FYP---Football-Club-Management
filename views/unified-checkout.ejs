<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheet/style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID || 'YOUR_SANDBOX_CLIENT_ID' %>&currency=USD"></script>
    <style>
        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .payment-methods {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .cart-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cashback-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .price-breakdown {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .price-row.total {
            border-top: 2px solid #007bff;
            padding-top: 10px;
            font-weight: bold;
            font-size: 1.2em;
        }
        .payment-tab {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-tab.active {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .payment-form {
            display: none;
            margin-top: 20px;
        }
        .payment-form.active {
            display: block;
        }
        #stripe-card-element {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn-checkout {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    
    <div class="checkout-container">
        <div class="row">
            <!-- Order Summary -->
            <div class="col-lg-8">
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    
                    <% if (membership.tier_name !== 'None') { %>
                    <div class="cashback-info">
                        <h5><i class="fas fa-star"></i> <%= membership.tier_name %> Member Benefits</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Available Cashback:</strong><br>
                                $<%= (parseFloat(membership.cashback_accumulated) || 0).toFixed(2) %>
                            </div>
                            <div class="col-md-4">
                                <strong>Member Discount:</strong><br>
                                <%= parseFloat(membership.discount_percentage) || 0 %>%
                            </div>
                            <div class="col-md-4">
                                <strong>Cashback Rate:</strong><br>
                                <%= parseFloat(membership.cashback_rate) || 0 %>%
                            </div>
                        </div>
                    </div>
                    <% } %>
                    
                    <!-- Gear Items -->
                    <% if (gearCart.length > 0) { %>
                    <div class="mb-4">
                        <h5><i class="fas fa-shopping-bag"></i> Gear Items</h5>
                        <% gearCart.forEach(item => { %>
                        <div class="cart-item">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <img src="/images/<%= item.gear_image || 'placeholder.jpg' %>" 
                                         alt="<%= item.gear_name %>" class="img-fluid" style="max-height: 60px;">
                                </div>
                                <div class="col-md-6">
                                    <h6><%= item.gear_name %></h6>
                                    <small class="text-muted">Quantity: <%= item.quantity || 1 %></small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <strong>$<%= (parseFloat(item.price_per_unit) * (item.quantity || 1)).toFixed(2) %></strong>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>
                    
                    <!-- Ticket Items -->
                    <% if (reservedTickets.length > 0) { %>
                    <div class="mb-4">
                        <h5><i class="fas fa-ticket-alt"></i> Event Tickets</h5>
                        <% reservedTickets.forEach(ticket => { %>
                        <div class="cart-item">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6><%= ticket.event_name %></h6>
                                    <small class="text-muted">
                                        Date: <%= new Date(ticket.event_date).toLocaleDateString() %>
                                        | Quantity: <%= ticket.quantity %>
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <strong>$<%= parseFloat(ticket.final_price || ticket.ticket_price).toFixed(2) %></strong>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>
                    
                    <% if (gearCart.length === 0 && reservedTickets.length === 0) { %>
                    <div class="text-center py-4">
                        <h5>Your cart is empty</h5>
                        <p>Add some items to your cart to proceed with checkout.</p>
                        <a href="/store" class="btn btn-primary me-2">Shop Gear</a>
                        <a href="/events" class="btn btn-secondary">Browse Events</a>
                    </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="col-lg-4">
                <div class="price-breakdown">
                    <h5>Price Breakdown</h5>
                    
                    <div class="price-row">
                        <span>Subtotal:</span>
                        <span>$<%= subtotal %></span>
                    </div>
                    
                    <% if (parseFloat(membershipDiscount) > 0) { %>
                    <div class="price-row text-success">
                        <span>Member Discount:</span>
                        <span>-$<%= membershipDiscount %></span>
                    </div>
                    <% } %>
                    
                    <% if (parseFloat(membership.cashback_accumulated) > 0) { %>
                    <div class="price-row text-info">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <span>Apply Cashback:</span>
                            <div class="d-flex align-items-center gap-2">
                                <span>$</span>
                                <input type="number" 
                                       id="cashbackSlider" 
                                       class="form-control form-control-sm" 
                                       style="width: 80px;" 
                                       min="0" 
                                       max="<%= parseFloat(membership.cashback_accumulated) || 0 %>" 
                                       step="0.01" 
                                       value="<%= cashbackToApply %>"
                                       onchange="updateTotals()">
                                <small class="text-muted">/ $<%= (parseFloat(membership.cashback_accumulated) || 0).toFixed(2) %></small>
                            </div>
                        </div>
                    </div>
                    <% } %>
                    
                    <div class="price-row total">
                        <span>Total:</span>
                        <span id="finalTotalDisplay">$<%= finalTotal %></span>
                    </div>
                    
                    <% if (parseFloat(newCashbackEarned) > 0) { %>
                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-success">
                            <i class="fas fa-coins"></i> You'll earn $<%= newCashbackEarned %> cashback on this purchase!
                        </small>
                    </div>
                    <% } %>
                </div>
                
                <% if (gearCart.length > 0 || reservedTickets.length > 0) { %>
                <div class="payment-methods mt-3">
                    <h5>Payment Method</h5>
                    
                    <!-- Stripe Payment Tab -->
                    <div class="payment-tab active" data-method="stripe">
                        <div class="d-flex align-items-center">
                            <input type="radio" name="payment_method" value="stripe" checked class="me-2">
                            <div>
                                <strong>Credit/Debit Card</strong>
                                <div class="text-muted small">Powered by Stripe</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PayPal Payment Tab -->
                    <div class="payment-tab" data-method="paypal">
                        <div class="d-flex align-items-center">
                            <input type="radio" name="payment_method" value="paypal" class="me-2">
                            <div>
                                <strong>PayPal</strong>
                                <div class="text-muted small">Pay with your PayPal account</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stripe Form -->
                    <div id="stripe-form" class="payment-form active">
                        <div id="stripe-card-element">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <div id="stripe-card-errors" role="alert" class="text-danger mt-2"></div>
                        <button id="stripe-submit" class="btn btn-primary btn-checkout mt-3">
                            Complete Payment - $<%= finalTotal %>
                        </button>
                    </div>
                    
                    <!-- PayPal Form -->
                    <div id="paypal-form" class="payment-form">
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <script>
        // Payment method switching
        document.querySelectorAll('.payment-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const method = this.dataset.method;
                
                // Update active states
                document.querySelectorAll('.payment-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.payment-form').forEach(f => f.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`${method}-form`).classList.add('active');
                
                // Update radio button
                document.querySelector(`input[value="${method}"]`).checked = true;
            });
        });
        
        <% if (gearCart.length > 0 || reservedTickets.length > 0) { %>
        // Initialize Stripe
        const stripe = Stripe('<%= stripePublishableKey %>');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#stripe-card-element');
        
        // Handle Stripe form submission
        document.getElementById('stripe-submit').addEventListener('click', async (event) => {
            event.preventDefault();
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Processing...';
            
            try {
                // Create payment intent
                const cashbackAmount = parseFloat(document.getElementById('cashbackSlider')?.value) || 0;
                const response = await fetch('/unified-payments/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        usePaypal: false,
                        cashbackToApply: cashbackAmount
                    })
                });
                
                const { client_secret } = await response.json();
                
                // Confirm payment
                const result = await stripe.confirmCardPayment(client_secret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: '<%= user.first_name %> <%= user.surname %>',
                            email: '<%= user.email %>'
                        }
                    }
                });
                
                if (result.error) {
                    document.getElementById('stripe-card-errors').textContent = result.error.message;
                    button.disabled = false;
                    button.textContent = 'Complete Payment - $<%= finalTotal %>';
                } else {
                    // Payment succeeded
                    await fetch('/unified-payments/stripe/confirm-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            payment_intent_id: result.paymentIntent.id
                        })
                    });
                    
                    window.location.href = '/unified-payments/success';
                }
            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('stripe-card-errors').textContent = 'An error occurred processing your payment.';
                button.disabled = false;
                button.textContent = 'Complete Payment - $<%= finalTotal %>';
            }
        });
        
        // Initialize PayPal
        paypal.Buttons({
            createOrder: async function(data, actions) {
                const cashbackAmount = parseFloat(document.getElementById('cashbackSlider')?.value) || 0;
                const response = await fetch('/unified-payments/paypal/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cashbackToApply: cashbackAmount
                    })
                });
                
                const orderData = await response.json();
                return orderData.id;
            },
            onApprove: async function(data, actions) {
                const response = await fetch(`/unified-payments/paypal/capture/${data.orderID}`, {
                    method: 'POST'
                });
                
                const orderData = await response.json();
                
                if (orderData.success) {
                    window.location.href = '/unified-payments/paypal/success';
                } else {
                    alert('Payment failed. Please try again.');
                }
            },
            onError: function(err) {
                console.error('PayPal error:', err);
                alert('An error occurred with PayPal. Please try again.');
            }
        }).render('#paypal-button-container');
        <% } %>
        
        // Update totals when cashback amount changes
        function updateTotals() {
            const cashbackInput = document.getElementById('cashbackSlider');
            const cashbackAmount = parseFloat(cashbackInput.value) || 0;
            const subtotal = <%= subtotal %>;
            const membershipDiscount = <%= membershipDiscount %>;
            const totalAfterDiscount = subtotal - membershipDiscount;
            
            // Calculate new final total
            const newFinalTotal = Math.max(0, totalAfterDiscount - cashbackAmount);
            
            // Calculate new cashback earned
            const cashbackRate = <%= parseFloat(membership.cashback_rate) || 0 %>;
            const newCashbackEarned = newFinalTotal * (cashbackRate / 100);
            
            // Update display
            document.getElementById('finalTotalDisplay').textContent = '$' + newFinalTotal.toFixed(2);
            
            // Update cashback earned message
            const cashbackEarnedEl = document.querySelector('.text-success small');
            if (cashbackEarnedEl && newCashbackEarned > 0) {
                cashbackEarnedEl.innerHTML = '<i class="fas fa-coins"></i> You\'ll earn $' + newCashbackEarned.toFixed(2) + ' cashback on this purchase!';
            }
            
            // Update payment button text
            const stripeButton = document.getElementById('stripe-submit');
            if (stripeButton) {
                stripeButton.textContent = 'Complete Payment - $' + newFinalTotal.toFixed(2);
            }
        }
    </script>
    
    <%- include('partials/footer') %>
</body>
</html>
